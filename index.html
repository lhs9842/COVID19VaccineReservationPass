<!DOCTYPE html>
<head>
	<meta charset="utf-8" />
	<title>코로나19 예방접종 사전예약 페이지 접속</title>
	<script type="text/javascript" src="https://ncvr.kdca.go.kr/js/front/netfunnel.js?ver=21080316" charset="UTF-8"></script>
    <script type="text/javascript" src="https://ncvr.kdca.go.kr/js/front/netfunel_skin.js?ver=21080316" charset="UTF-8"></script>
	<script>
		function refreshKey(key){
			var netfunnel = new XMLHttpRequest();
			netfunnel.onreadystatechange = function(){
				if(netfunnel.readyState === netfunnel.DONE){
					if(netfunnel.status === 200 || netfunnel.status === 201){
						var respon = netfunnel.responseText;
						var codeIndex = respon.indexOf(":") + 1;
						var code = respon.substr(codeIndex, 3);
						if(code != "200" && code != "201"){
							document.getElementById("code").value=code;
							document.getElementById("key").value=key;
							startWait();
							return 0;
						}
						var nwaitIndex = respon.indexOf("nwait=") + 6;
						var keyIndex = respon.indexOf("key=") + 4;
						var nextIndex = respon.indexOf("&nnext");
						document.getElementById("nwait").value = respon.substr(nwaitIndex, nextIndex - nwaitIndex);
						var key = respon.substr(keyIndex, nwaitIndex - 6 - keyIndex - 1);
						document.getElementById("key").value=key;
						setTimeout(()=>refreshKey(document.getElementById("key").value), 500);
					}
					else if(netfunnel.status === 0){
						alert("CORS 오류 발생!! 확장기능 설치 및 활성화 여부를 확인하고, 확장기능의 Reload active tab을 눌러 본 페이지를 다시 로드해주세요.");
					}
					else{
						alert("확인되지 않은 오류 방생!! 인터넷 연결 상태를 확인하세요.")
					}
				}
			}
			var keyUrl = "https://kdca.netfunnel.co.kr/ts.wseq?opcode=5002&key=" + key;
			keyUrl = keyUrl + "&nfid=0&prefix=NetFunnel.gRtype=5002;&ttl=3&sid=service_1&aid=procCI01&js=yes&1628075021565";
			netfunnel.open("GET", keyUrl);
			netfunnel.send();
		}
		function startWait(){
			var netfunnel = new XMLHttpRequest();
			netfunnel.onreadystatechange = function(){
				if(netfunnel.readyState === netfunnel.DONE){
					if(netfunnel.status === 200 || netfunnel.status === 201){
						var respon = netfunnel.responseText;
						var codeIndex = respon.indexOf(":") + 1;
						var code = respon.substr(codeIndex, 3);
						if(code != "200" && code != "201"){
							document.getElementById("code").value=code;
							document.getElementById("key").value=key;
							startWait();
							return 0;
						}
						var nwaitIndex = respon.indexOf("nwait=") + 6;
						var keyIndex = respon.indexOf("key=") + 4;
						var nextIndex = respon.indexOf("&nnext");
						document.getElementById("nwait").value = respon.substr(nwaitIndex, nextIndex - nwaitIndex);
						var key = respon.substr(keyIndex, nwaitIndex - 6 - keyIndex - 1);
						document.getElementById("key").value=key;
						setTimeout(()=>refreshKey(document.getElementById("key").value), 500);
					}
					else if(netfunnel.status === 0){
						alert("CORS 오류 발생!! 확장기능 설치 및 활성화 여부를 확인하고, 확장기능의 Reload active tab을 눌러 본 페이지를 다시 로드해주세요.");
					}
					else{
						alert("확인되지 않은 오류 방생!! 인터넷 연결 상태를 확인하세요.")
					}
				}
			}
			var keyUrl = "https://kdca.netfunnel.co.kr/ts.wseq?opcode=5101&nfid=0&prefix=NetFunnel.gRtype=5101;&sid=service_1&aid=procCI01&js=yes&1628429769589"
			netfunnel.open("GET", keyUrl);
			netfunnel.send();
		};
	</script>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-4EMLC6DKCT"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());
		gtag('config', 'G-4EMLC6DKCT');
	</script>
</head>
<body>
	<h1>예약페이지 접속 용 NetFunnel Key 가져오기</h1>
	<h3 style="color:rgb(255,0,0);">대기열 시작을 <b><u>예약 시작 시간(20시) 전에 미리 누르셔야</u></b> 합니다!!!</h3>
	<h3 style="color:rgb(255,0,0);">사용 전 <a href="https://chrome.google.com/webstore/detail/allow-cors-access-control/lhobafahddgcelffkeicbaginigeejlf?hl=ko">여기</a>에 접속 후 확장 기능을 설치하고, 확장기능을 활성화하셔야 이용이 가능합니다.</h3>
	<button id="start" onclick="startWait();">대기열 시작하기</button>
	<h5>이 페이지는 접속을 위한 파이썬 코드에서 사용되기 위해 개발되었습니다. 해당 코드는 <a href="/Covid19VaccineRegister.py">여기</a>에서 다운로드하실 수 있습니다.</h5>
	<h4 style="color:rgb(255,0,0);">아래 <b><u>nwait 값이 0이 아니거나 code 값이 200, 201이 아닐 때의 키를 사용하시면 안됩니다</u></b>!!</h4>
	<h5>정상적으로 작동한다면 아래 <u>Netfunnel Key 값이 지속적으로 변경</u>됩니다. 값이 나타나지 않거나 변화가 멈춘 경우 인터넷 연결 상태 확인 후 대기열 시작버튼울 다시 누르세요.</h5>
	<h5><u style="color:rgb(255,0,0);">백신 예약이 완료되면 설치한 CORS 확장 기능을 비활성화하고 제거할 것을 강력히 권고합니다.</u> 외부 서버 페이지에서 질병관리청 넷퓨넬 서버의 내용물을 가져오기 위해 이용을 요청하였습니다만, <u style="color:rgb(255,0,0);">이는 브라우저가 제공하는 <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/CORS" target="_blank">보안 기능 중 일부</a>를 무력화합니다.</u></h5>
	nwait : <input type="text" id="nwait" value="" disabled><br>
	code : <input type="text" id="code" value="" disabled>
	<form method="post" action="https://ncvr2.kdca.go.kr/svc/complete" target="_blank">
		Netfunnel Key : <input type="text" id="key" name="nfKey" value="" size=250>
	</form>
	<p>이 웹 문서에 대한 상세한 설명은 <a href="/README.html">여기</a>를 눌러 확인하실 수 있습니다.</p>
</body>